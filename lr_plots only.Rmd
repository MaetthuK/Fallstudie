---
title: "LR Plots Only"
author: "Dein Name"
date: "`r Sys.Date()`"
output: html_document
---

# 1. Setup

## 1.1 Packages and Libraries
Stelle sicher, dass alle ben&ouml;tigten Libraries installiert und geladen sind. (Die Installation wird hier einmalig gezeigt, falls Du sie noch nicht installiert hast.)
```{r install-packages, eval=FALSE}
# install.packages(c("tidyverse", "ggplot2", "dplyr", "corrplot", "caret", "pROC"))
```

```{r load-libraries}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(corrplot)
library(caret)
library(pROC)
```

## 1.2 CSV-Dateien Anbindung
Die Trainings- und Testdaten werden aus den entsprechenden CSV-Dateien eingelesen. Anschlie&szlig;end &uuml;berpr&uuml;fen wir stichprobenartig, ob die Daten korrekt geladen wurden.
```{r load-data}
train_data <- read.csv("bloodtrain.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
test_data  <- read.csv("bloodtest.csv",  header = TRUE, sep = ",", stringsAsFactors = FALSE)

colnames(train_data) <- c(
  "ID",
  "Monate Letzte Spende",
  "Anzahl Spenden",
  "Gesamtvolumen",
  "Monate Erste Spende",
  "Spende Maerz 2007"
)

# --- A.3) Spaltennamen anpassen (Test) --------------------------------------
colnames(test_data) <- c(
  "ID",
  "Monate Letzte Spende",
  "Anzahl Spenden",
  "Gesamtvolumen",
  "Monate Erste Spende"
)

# Erste Zeilen anzeigen
head(train_data)
head(test_data)
```

# 2. Datenverständnis

## 2.1 Struktur & fehlende Werte
Wir untersuchen die Struktur der Datens&auml;tze und pr&uuml;fen, ob NA-Werte vorhanden sind.
```{r data-structure}
str(train_data)
str(test_data)

# Fehlende Werte pro Spalte
colSums(is.na(train_data))
colSums(is.na(test_data))
```

## 2.2 Duplikate prüfen
Duplikate in den Trainingsdaten werden gesucht und ggf. angezeigt.
```{r duplicates}
duplicated_rows <- duplicated(train_data)
if(any(duplicated_rows)) {
  print("Gefundene Duplikate:")
  print(train_data[duplicated_rows, ])
} else {
  print("Keine Duplikate gefunden.")
}
```

# 3. Explorative Datenanalyse

## 3.1 Plot der Zielvariable
Ein schneller Barplot zur Verteilung der Zielvariable (angenommen, sie hei&szlig;t `SpendeMaerz2007`).
```{r target-barplot}
ggplot(train_data, aes(x = factor(`Spende Maerz 2007`))) +
  geom_bar(fill = "steelblue") +
  labs(title = "Verteilung der Zielvariable (Trainingsdaten)",
       x = "SpendeMaerz2007 (Nein/Ja)" +
       # Achsenbeschriftung anstatt 01 bitte "Nein" und "Ja"
       scale_x_discrete(labels = c("Nein", "Ja")),
       y = "Häufigkeit")
```

## 3.2 Boxplots: Beispiel "Monate seit letzter Spende"
Hier gehen wir davon aus, dass im Datensatz die Variable `MonateLetzteSpende` (bzw. in Kombination mit `MonateErsteSpende`) vorliegt.  
Falls gewünscht, kannst Du &uuml;ber diesen Unterschied beispielsweise einen Boxplot f&uuml;r Trainings- und Testdaten erstellen.
```{r boxplots}
# Trainingsdaten
ggplot(train_data, aes(y = `Monate Letzte Spende`)) +
  geom_boxplot(fill = "steelblue") +
  labs(title = "Boxplot Monate Letzte Spende - Trainingsdaten",
       y = "Monate seit letzter Spende")

# Testdaten
ggplot(test_data, aes(y = `Monate Letzte Spende`)) +
  geom_boxplot(fill = "orange") +
  labs(title = "Boxplot MonateLetzteSpende - Testdaten",
       y = "Monate seit letzter Spende")
```

## 3.3 Histogramme: Anzahl Spenden
Histogramme zur Darstellung der Verteilung des Pr&auml;diktors `AnzahlSpenden`.
```{r histograms}
ggplot(train_data, aes(x = `Anzahl Spenden`)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black") +
  labs(title = "Histogramm AnzahlSpenden (Train)",
       x = "Anzahl Spenden",
       y = "H&auml;ufigkeit")

ggplot(test_data, aes(x = `Anzahl Spenden`)) +
  geom_histogram(binwidth = 1, fill = "orange", color = "black") +
  labs(title = "Histogramm AnzahlSpenden (Test)",
       x = "Anzahl Spenden",
       y = "H&auml;ufigkeit")
```

## 3.4 Pairs-Plot & Korrelationsmatrix
Ein Pairs-Plot zeigt die Beziehungen zwischen den numerischen Variablen. Anschlie&szlig;end wird eine Korrelationsmatrix erstellt.
```{r pairs-corr}
# Extrahiere numerische Spalten
num_cols <- train_data %>% select_if(is.numeric)

# Pairs-Plot
pairs(num_cols, main = "Pairs Plot - Trainingsdaten")

# Korrelationsmatrix und corrplot
cor_mat <- cor(num_cols, use = "complete.obs")
corrplot(cor_mat, method = "circle", type = "upper", 
         title = "Korrelation (Trainingsdaten)", tl.cex = 0.8, mar = c(0,0,1,0))
```

# 4. Feature Engineering
Erstelle einen neuen Pr&auml;diktor, z.B. die SpendenRate. Hier wird angenommen, dass man die Differenz zwischen `MonateLetzteSpende` und `MonateErsteSpende` berechnet (als Indikator f&uuml;r die Donation-Dauer).  
Falls der Unterschied 0 ergeben sollte, ist ein entsprechender Schutz einzubauen.
```{r feature-engineering, message=FALSE, warning=FALSE}
# 1) Libraries laden (nur wenn noch nicht oben geschehen)
library(tidyverse)
library(ggplot2)

# 2) Einlesen und direkt umbenennen, damit keine Leerzeichen in den Spaltennamen vorkommen:
train_data <- read.csv("bloodtrain.csv", 
                       header = TRUE, 
                       sep = ",", 
                       stringsAsFactors = FALSE)

colnames(train_data) <- c(
  "ID",
  "MonateLetzteSpende",
  "AnzahlSpenden",
  "Gesamtvolumen",
  "MonateErsteSpende",
  "SpendeMaerz2007"
)

# 3) Neuer Datensatz mit Feature Engineering
train_data_clean <- train_data %>%
  mutate(
    # Berechnung: Dauer seit erster Spende MINUS Dauer seit letzter Spende
    MonateSeither = MonateErsteSpende - MonateLetzteSpende,
    # Nur wenn MonateSeither > 0, wird SpendenRate berechnet, sonst NA
    SpendenRate   = ifelse(MonateSeither > 0,
                           AnzahlSpenden / MonateSeither,
                           NA_real_)
  )

# 4) Schneller Blick ins Ergebnis
summary(train_data_clean$MonateSeither)
summary(train_data_clean$SpendenRate)

# 5) Plot: Histogramm des neuen Prädiktors "SpendenRate"
ggplot(train_data_clean, aes(x = SpendenRate)) +
  geom_histogram(binwidth = 0.1, fill = "darkgreen", color = "black") +
  labs(
    title = "Histogramm neuer Prädiktor: SpendenRate",
    x = "SpendenRate",
    y = "Häufigkeit"
  )



```

# 5. Modell & Auswertung (Plotausgabe)
Zum Abschluss wird ein einfaches logistisches Regressionsmodell gebaut und dessen Ergebnisse visualisiert.

## 5.1 Logistisches Regressionsmodell
Wir passen ein Modell an, dass u.a. `AnzahlSpenden`, `MonateLetzteSpende` und den neuen Pr&auml;diktor `SpendenRate` verwendet.  
(Dabei muss die Zielvariable 0/1-codiert sein.)
```{r model}
# Konvertiere Zielvariable in numerisch (bzw. Faktor), falls erforderlich
train_data_clean$SpendeMaerz2007 <- as.factor(train_data_clean$SpendeMaerz2007)

glm_model <- glm(SpendeMaerz2007 ~ AnzahlSpenden + MonateLetzteSpende + SpendenRate,
                 data = train_data_clean,
                 family = binomial)

summary(glm_model)
```

## 5.2 Konfusionsmatrix und ROC-Plot
Erstelle Vorhersagen f&uuml;r den Trainingsdatensatz, generiere eine Konfusionsmatrix und plotte die ROC-Kurve.
```{r model-evaluation}
# Vorhersagewahrscheinlichkeit
pred_train <- predict(glm_model, train_data_clean, type = "response")
# Klassifikation mit 0.5-Schwelle
pred_class <- ifelse(pred_train > 0.5, 1, 0)

# Konfusionsmatrix
conf_matrix <- confusionMatrix(factor(pred_class), factor(train_data_clean$SpendeMaerz2007))
print(conf_matrix)

# ROC-Plot
roc_obj <- roc(as.numeric(train_data_clean$SpendeMaerz2007), pred_train)
plot(roc_obj, col = "blue", main = "ROC-Kurve - Logistische Regression (Train)")
auc_value <- auc(roc_obj)
cat("AUC: ", auc_value)
```

# 6. Fazit
Dies ist ein grober &Uuml;berblick &uuml;ber die Daten, das Feature Engineering und den Modellierungsprozess. Auf Basis der Plots k&ouml;nnen Hinweise zur Optimierung des Modells gewonnen werden.